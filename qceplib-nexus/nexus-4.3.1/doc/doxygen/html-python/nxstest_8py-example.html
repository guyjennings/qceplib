<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>NeXus: nxstest.py</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">NeXus
   &#160;<span id="projectnumber">1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.1.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Packages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">nxstest.py</div>  </div>
</div><!--header-->
<div class="contents">
<p>Test program for NeXus python interface</p>
<div class="fragment"><div class="line"><span class="comment"># This program is public domain</span></div>
<div class="line"></div>
<div class="line"><span class="comment"># Author: Paul Kienzle</span></div>
<div class="line"></div>
<div class="line"><span class="comment">##</span></div>
<div class="line"><span class="comment"># </span></div>
<div class="line"><span class="comment"># NeXus tests converted to python.</span></div>
<div class="line"><span class="comment"># </span></div>
<div class="line"></div>
<div class="line"><span class="keyword">import</span> nxs,os,numpy,sys</div>
<div class="line"></div>
<div class="line"><span class="keyword">def </span>memfootprint():</div>
<div class="line">    <span class="keyword">import</span> gc</div>
<div class="line">    objs = gc.get_objects()</div>
<div class="line">    classes = set( c.__class__ <span class="keywordflow">for</span> c <span class="keywordflow">in</span> gc.get_objects() <span class="keywordflow">if</span> hasattr(c,<span class="stringliteral">&#39;__class__&#39;</span>) )</div>
<div class="line">    <span class="comment"># print &quot;\n&quot;.join([c.__name__ for c in classes])</span></div>
<div class="line">    <span class="keywordflow">print</span> <span class="stringliteral">&quot;#objects=&quot;</span>,len(objs)</div>
<div class="line">    <span class="keywordflow">print</span> <span class="stringliteral">&quot;#classes=&quot;</span>,len(classes)</div>
<div class="line"></div>
<div class="line"><span class="keyword">def </span>leak_test1(n = 1000, mode=&#39;w5&#39;):</div>
<div class="line"><span class="comment">#    import gc</span></div>
<div class="line"><span class="comment">#    gc.enable()</span></div>
<div class="line"><span class="comment">#    gc.set_debug(gc.DEBUG_LEAK)</span></div>
<div class="line">    filename = <span class="stringliteral">&quot;leak_test1.nxs&quot;</span></div>
<div class="line">    <span class="keywordflow">try</span>: os.unlink(filename)</div>
<div class="line">    <span class="keywordflow">except</span> OSError: <span class="keywordflow">pass</span></div>
<div class="line">    file = nxs.open(filename,mode)</div>
<div class="line">    file.close()</div>
<div class="line">    <span class="keywordflow">print</span> <span class="stringliteral">&quot;File should exist now&quot;</span></div>
<div class="line">    <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(n):</div>
<div class="line">        <span class="keywordflow">if</span> i%100 == 0: </div>
<div class="line">            <span class="keywordflow">print</span> <span class="stringliteral">&quot;loop count %d&quot;</span>%i</div>
<div class="line">            memfootprint()</div>
<div class="line">        file.open()</div>
<div class="line">        file.close()</div>
<div class="line"><span class="comment">#        gc.collect()</span></div>
<div class="line">    os.unlink(filename)</div>
<div class="line"></div>
<div class="line"><span class="keyword">def </span>_show(file, indent=0):</div>
<div class="line">    prefix = <span class="stringliteral">&#39; &#39;</span>*indent</div>
<div class="line">    link = file.link()</div>
<div class="line">    <span class="keywordflow">if</span> link:</div>
<div class="line">        <span class="keywordflow">print</span> <span class="stringliteral">&quot;%(prefix)s-&gt; %(link)s&quot;</span> % locals()</div>
<div class="line">        <span class="keywordflow">return</span></div>
<div class="line">    <span class="keywordflow">for</span> attr,value <span class="keywordflow">in</span> file.attrs():</div>
<div class="line">        <span class="keywordflow">print</span> <span class="stringliteral">&quot;%(prefix)s@%(attr)s: %(value)s&quot;</span> % locals()</div>
<div class="line">    <span class="keywordflow">for</span> name,nxclass <span class="keywordflow">in</span> file.entries():</div>
<div class="line">        <span class="keywordflow">if</span> nxclass == <span class="stringliteral">&quot;SDS&quot;</span>:</div>
<div class="line">            shape,dtype = file.getinfo()</div>
<div class="line">            dims = <span class="stringliteral">&quot;x&quot;</span>.join([str(x) <span class="keywordflow">for</span> x <span class="keywordflow">in</span> shape])</div>
<div class="line">            <span class="keywordflow">print</span> <span class="stringliteral">&quot;%(prefix)s%(name)s %(dtype)s %(dims)s&quot;</span> % locals()</div>
<div class="line">            link = file.link()</div>
<div class="line">            <span class="keywordflow">if</span> link:</div>
<div class="line">                <span class="keywordflow">print</span> <span class="stringliteral">&quot;  %(prefix)s-&gt; %(link)s&quot;</span> % locals()</div>
<div class="line">            <span class="keywordflow">else</span>:</div>
<div class="line">                <span class="keywordflow">for</span> attr,value <span class="keywordflow">in</span> file.attrs():</div>
<div class="line">                    <span class="keywordflow">print</span> <span class="stringliteral">&quot;  %(prefix)s@%(attr)s: %(value)s&quot;</span> % locals()</div>
<div class="line">                <span class="keywordflow">if</span> numpy.prod(shape) &lt; 8:</div>
<div class="line">                    value = file.getdata()</div>
<div class="line">                    <span class="keywordflow">print</span> <span class="stringliteral">&quot;  %s%s&quot;</span>%(prefix,str(value))</div>
<div class="line">        <span class="keywordflow">else</span>:</div>
<div class="line">            <span class="keywordflow">print</span> <span class="stringliteral">&quot;%(prefix)s%(name)s %(nxclass)s&quot;</span> % locals()</div>
<div class="line">            _show(file, indent+2)</div>
<div class="line"></div>
<div class="line"><span class="keyword">def </span>show_structure(filename):</div>
<div class="line">    file = nxs.open(filename)</div>
<div class="line">    <span class="keywordflow">print</span> <span class="stringliteral">&quot;=== File&quot;</span>,file.inquirefile()</div>
<div class="line">    _show(file)</div>
<div class="line">    </div>
<div class="line"></div>
<div class="line"><span class="keyword">def </span>populate(filename,mode):</div>
<div class="line">    i1 = numpy.arange(4,dtype=<span class="stringliteral">&#39;uint8&#39;</span>)</div>
<div class="line">    i2 = numpy.arange(4,dtype=<span class="stringliteral">&#39;int16&#39;</span>)*1000</div>
<div class="line">    i4 = numpy.arange(4,dtype=<span class="stringliteral">&#39;int32&#39;</span>)*1000000</div>
<div class="line">    i8 = numpy.arange(4,dtype=<span class="stringliteral">&#39;int64&#39;</span>)*1000000000000</div>
<div class="line">    r4 = numpy.arange(20,dtype=<span class="stringliteral">&#39;float32&#39;</span>).reshape((5,4))</div>
<div class="line">    r8 = numpy.arange(20,dtype=<span class="stringliteral">&#39;float64&#39;</span>).reshape((5,4))</div>
<div class="line">    comp_array=numpy.ones((100,20),dtype=<span class="stringliteral">&#39;int32&#39;</span>)</div>
<div class="line">    <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(100): comp_array[i,:] *= i</div>
<div class="line"></div>
<div class="line">    file = nxs.open(filename,mode)</div>
<div class="line">    file.setnumberformat(<span class="stringliteral">&#39;float32&#39;</span>,<span class="stringliteral">&#39;%9.3g&#39;</span>)</div>
<div class="line">    file.makegroup(<span class="stringliteral">&quot;entry&quot;</span>,<span class="stringliteral">&quot;NXentry&quot;</span>)</div>
<div class="line">    file.opengroup(<span class="stringliteral">&quot;entry&quot;</span>,<span class="stringliteral">&quot;NXentry&quot;</span>)</div>
<div class="line">    file.putattr(<span class="stringliteral">&quot;hugo&quot;</span>,<span class="stringliteral">&quot;namenlos&quot;</span>)</div>
<div class="line">    file.putattr(<span class="stringliteral">&quot;cucumber&quot;</span>,<span class="stringliteral">&quot;passion&quot;</span>)</div>
<div class="line">    <span class="comment">#file.putattr(&quot;embedded_null&quot;,&quot;embedded\000null&quot;)</span></div>
<div class="line"></div>
<div class="line">    <span class="comment"># Write character data</span></div>
<div class="line">    file.makedata(<span class="stringliteral">&quot;ch_data&quot;</span>,<span class="stringliteral">&#39;char&#39;</span>,[10])</div>
<div class="line">    file.opendata(<span class="stringliteral">&quot;ch_data&quot;</span>)</div>
<div class="line">    file.putdata(<span class="stringliteral">&quot;NeXus data&quot;</span>)</div>
<div class="line">    file.closedata()</div>
<div class="line">    </div>
<div class="line">    <span class="comment"># Write numeric data</span></div>
<div class="line">    <span class="keywordflow">for</span> var <span class="keywordflow">in</span> [<span class="stringliteral">&#39;i1&#39;</span>,<span class="stringliteral">&#39;i2&#39;</span>,<span class="stringliteral">&#39;i4&#39;</span>,<span class="stringliteral">&#39;i8&#39;</span>,<span class="stringliteral">&#39;r4&#39;</span>]:</div>
<div class="line">        <span class="keywordflow">if</span> mode == <span class="stringliteral">&#39;w4&#39;</span> <span class="keywordflow">and</span> var == <span class="stringliteral">&#39;i8&#39;</span>: <span class="keywordflow">continue</span></div>
<div class="line">        name = var+<span class="stringliteral">&#39;_data&#39;</span></div>
<div class="line">        val = locals()[var]</div>
<div class="line">        file.makedata(name,val.dtype,val.shape)</div>
<div class="line">        file.opendata(name)</div>
<div class="line">        file.putdata(val)</div>
<div class="line">        file.closedata()</div>
<div class="line">    </div>
<div class="line">    <span class="comment"># Write r8_data</span></div>
<div class="line">    file.makedata(<span class="stringliteral">&#39;r8_data&#39;</span>,<span class="stringliteral">&#39;float64&#39;</span>,[5,4])</div>
<div class="line">    file.opendata(<span class="stringliteral">&#39;r8_data&#39;</span>)</div>
<div class="line">    file.putslab(r8[4,:],[4,0],[1,4])</div>
<div class="line">    file.putslab(r8[0:4,:],[0,0],[4,4])</div>
<div class="line">    file.putattr(<span class="stringliteral">&quot;ch_attribute&quot;</span>,<span class="stringliteral">&quot;NeXus&quot;</span>)</div>
<div class="line">    file.putattr(<span class="stringliteral">&quot;i4_attribute&quot;</span>,42,dtype=<span class="stringliteral">&#39;int32&#39;</span>)</div>
<div class="line">    file.putattr(<span class="stringliteral">&quot;r4_attribute&quot;</span>,3.14159265,dtype=<span class="stringliteral">&#39;float32&#39;</span>)</div>
<div class="line">    <span class="comment">## Oops... NAPI doesn&#39;t support array attributes</span></div>
<div class="line">    <span class="comment">#file.putattr(&quot;i4_array&quot;,[3,2],dtype=&#39;int32&#39;)</span></div>
<div class="line">    <span class="comment">#file.putattr(&quot;r4_array&quot;,[3.14159265,2.718281828],dtype=&#39;float32&#39;)</span></div>
<div class="line">    dataID = file.getdataID()</div>
<div class="line">    file.closedata()</div>
<div class="line"></div>
<div class="line">    <span class="comment"># Create the NXdata group</span></div>
<div class="line">    file.makegroup(<span class="stringliteral">&quot;data&quot;</span>,<span class="stringliteral">&quot;NXdata&quot;</span>)</div>
<div class="line">    file.opengroup(<span class="stringliteral">&quot;data&quot;</span>,<span class="stringliteral">&quot;NXdata&quot;</span>)</div>
<div class="line">    </div>
<div class="line">    <span class="comment"># .. demonstrate linking</span></div>
<div class="line">    file.makelink(dataID)</div>
<div class="line"></div>
<div class="line">    <span class="comment"># .. demonstrate compressed data</span></div>
<div class="line">    file.compmakedata(<span class="stringliteral">&quot;comp_data&quot;</span>,<span class="stringliteral">&#39;int32&#39;</span>,[100,20],<span class="stringliteral">&#39;lzw&#39;</span>,[20,20])</div>
<div class="line">    file.opendata(<span class="stringliteral">&#39;comp_data&#39;</span>)</div>
<div class="line">    file.putdata(comp_array)</div>
<div class="line">    file.closedata()</div>
<div class="line">    file.flush()</div>
<div class="line"></div>
<div class="line">    <span class="comment"># .. demonstrate extensible data</span></div>
<div class="line">    file.makedata(<span class="stringliteral">&#39;flush_data&#39;</span>,<span class="stringliteral">&#39;int32&#39;</span>,[nxs.UNLIMITED])</div>
<div class="line">    file.opendata(<span class="stringliteral">&#39;flush_data&#39;</span>)</div>
<div class="line">    <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(7):</div>
<div class="line">        file.putslab(i,[i],[1])</div>
<div class="line">    file.closedata()</div>
<div class="line">    file.flush()</div>
<div class="line">    file.closegroup()</div>
<div class="line"></div>
<div class="line">    <span class="comment"># Create NXsample group</span></div>
<div class="line">    file.makegroup(<span class="stringliteral">&#39;sample&#39;</span>,<span class="stringliteral">&#39;NXsample&#39;</span>)</div>
<div class="line">    file.opengroup(<span class="stringliteral">&#39;sample&#39;</span>,<span class="stringliteral">&#39;NXsample&#39;</span>)</div>
<div class="line">    file.makedata(<span class="stringliteral">&#39;ch_data&#39;</span>,<span class="stringliteral">&#39;char&#39;</span>,[20])</div>
<div class="line">    file.opendata(<span class="stringliteral">&#39;ch_data&#39;</span>)</div>
<div class="line">    file.putdata(<span class="stringliteral">&#39;NeXus sample&#39;</span>)</div>
<div class="line">    file.closedata()</div>
<div class="line">    sampleID = file.getgroupID()</div>
<div class="line">    file.closegroup()</div>
<div class="line">    file.closegroup()</div>
<div class="line"></div>
<div class="line">    <span class="comment"># Demonstrate named links</span></div>
<div class="line">    file.makegroup(<span class="stringliteral">&#39;link&#39;</span>,<span class="stringliteral">&#39;NXentry&#39;</span>)</div>
<div class="line">    file.opengroup(<span class="stringliteral">&#39;link&#39;</span>,<span class="stringliteral">&#39;NXentry&#39;</span>)</div>
<div class="line">    file.makelink(sampleID)</div>
<div class="line">    file.makenamedlink(<span class="stringliteral">&#39;renLinkGroup&#39;</span>,sampleID)</div>
<div class="line">    file.makenamedlink(<span class="stringliteral">&#39;renLinkData&#39;</span>,dataID)</div>
<div class="line">    file.closegroup()</div>
<div class="line">    </div>
<div class="line">    file.close()</div>
<div class="line">    <span class="keywordflow">return</span> filename</div>
<div class="line"></div>
<div class="line">failures = 0</div>
<div class="line"><span class="keyword">def </span>fail(msg):</div>
<div class="line">    <span class="keyword">global</span> failures</div>
<div class="line">    <span class="keywordflow">print</span> <span class="stringliteral">&quot;FAIL:&quot;</span>,msg</div>
<div class="line">    failures += 1</div>
<div class="line"></div>
<div class="line"><span class="comment">##</span></div>
<div class="line"><span class="comment"># </span></div>
<div class="line"><span class="comment">#     Compare two dictionaries printing how they differ.</span></div>
<div class="line"><span class="comment">#     </span></div>
<div class="line"><span class="keyword">def </span>dicteq(a,b):</div>
<div class="line">    <span class="keywordflow">for</span> k,v <span class="keywordflow">in</span> a.iteritems():</div>
<div class="line">        <span class="keywordflow">if</span> k <span class="keywordflow">not</span> <span class="keywordflow">in</span> b:</div>
<div class="line">            <span class="keywordflow">print</span> k,<span class="stringliteral">&quot;not in&quot;</span>,b</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">False</span></div>
<div class="line">        <span class="keywordflow">if</span> v != b[k]: </div>
<div class="line">            <span class="keywordflow">print</span> v,<span class="stringliteral">&quot;not equal&quot;</span>,b[k]</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">False</span></div>
<div class="line">    <span class="keywordflow">for</span> k,v <span class="keywordflow">in</span> b.iteritems():</div>
<div class="line">        <span class="keywordflow">if</span> k <span class="keywordflow">not</span> <span class="keywordflow">in</span> a: </div>
<div class="line">            <span class="keywordflow">print</span> k,<span class="stringliteral">&quot;not in&quot;</span>,a</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">False</span></div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">True</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">def </span>check(filename, mode):</div>
<div class="line">    <span class="keyword">global</span> failures</div>
<div class="line">    failures = 0</div>
<div class="line">    file = nxs.open(filename,<span class="stringliteral">&#39;rw&#39;</span>)</div>
<div class="line">    <span class="keywordflow">if</span> filename != file.inquirefile(): fail(<span class="stringliteral">&quot;Files don&#39;t match&quot;</span>)</div>
<div class="line"></div>
<div class="line">    <span class="comment"># check headers</span></div>
<div class="line">    num_attrs = file.getattrinfo()</div>
<div class="line">    wxattrs = [<span class="stringliteral">&#39;xmlns&#39;</span>,<span class="stringliteral">&#39;xmlns:xsi&#39;</span>,<span class="stringliteral">&#39;xsi:schemaLocation&#39;</span>, <span class="stringliteral">&#39;XML_version&#39;</span>]</div>
<div class="line">    w4attrs = [<span class="stringliteral">&#39;HDF_version&#39;</span>]</div>
<div class="line">    w5attrs = [<span class="stringliteral">&#39;HDF5_Version&#39;</span>]</div>
<div class="line">    extras = dict(wx=wxattrs,w4=w4attrs,w5=w5attrs)</div>
<div class="line">    expected_attrs = [<span class="stringliteral">&#39;NeXus_version&#39;</span>,<span class="stringliteral">&#39;file_name&#39;</span>,<span class="stringliteral">&#39;file_time&#39;</span>]+extras[mode]</div>
<div class="line">    <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(num_attrs):</div>
<div class="line">        name,dims,type = file.getnextattr()</div>
<div class="line">        <span class="keywordflow">if</span> name <span class="keywordflow">not</span> <span class="keywordflow">in</span> expected_attrs:</div>
<div class="line">            fail(<span class="stringliteral">&quot;attribute %s unexpected&quot;</span>%(name))</div>
<div class="line">    <span class="keywordflow">if</span> num_attrs != len(expected_attrs): </div>
<div class="line">        fail(<span class="stringliteral">&quot;Expected %d root attributes but got %d&quot;</span></div>
<div class="line">             % (len(expected_attrs),num_attrs))</div>
<div class="line">    </div>
<div class="line">    file.opengroup(<span class="stringliteral">&#39;entry&#39;</span>,<span class="stringliteral">&#39;NXentry&#39;</span>)</div>
<div class="line">    </div>
<div class="line">    expect = dict(hugo=<span class="stringliteral">&#39;namenlos&#39;</span>,cucumber=<span class="stringliteral">&#39;passion&#39;</span>)</div>
<div class="line">    <span class="comment">#expect[&#39;embedded_null&#39;] = &quot;embedded\000null&quot;</span></div>
<div class="line">    get = dict((k,v) <span class="keywordflow">for</span> k,v <span class="keywordflow">in</span> file.attrs())</div>
<div class="line">    same = dicteq(get,expect)</div>
<div class="line">    <span class="keywordflow">if</span> <span class="keywordflow">not</span> same: fail(<span class="stringliteral">&quot;/entry attributes are %s&quot;</span>%(get))</div>
<div class="line"></div>
<div class="line">    <span class="comment"># Check that the numbers are written correctly</span></div>
<div class="line">    <span class="keywordflow">for</span> name,dtype,shape,scale <span class="keywordflow">in</span> \</div>
<div class="line">        [(<span class="stringliteral">&#39;i1&#39;</span>,<span class="stringliteral">&#39;int8&#39;</span>,(4),1),</div>
<div class="line">         (<span class="stringliteral">&#39;i2&#39;</span>,<span class="stringliteral">&#39;int16&#39;</span>,(4),1000),</div>
<div class="line">         (<span class="stringliteral">&#39;i4&#39;</span>,<span class="stringliteral">&#39;int32&#39;</span>,(4),1000000),</div>
<div class="line">         (<span class="stringliteral">&#39;i8&#39;</span>,<span class="stringliteral">&#39;int64&#39;</span>,(4),1000000000000),</div>
<div class="line">         (<span class="stringliteral">&#39;r4&#39;</span>,<span class="stringliteral">&#39;float32&#39;</span>,(5,4),1),</div>
<div class="line">         (<span class="stringliteral">&#39;r8&#39;</span>,<span class="stringliteral">&#39;float64&#39;</span>,(5,4),1)</div>
<div class="line">         ]:</div>
<div class="line">        <span class="keywordflow">if</span> mode == <span class="stringliteral">&#39;w4&#39;</span> <span class="keywordflow">and</span> name == <span class="stringliteral">&#39;i8&#39;</span>: <span class="keywordflow">continue</span></div>
<div class="line">        n = numpy.prod(shape)</div>
<div class="line">        expected = numpy.arange(n,dtype=dtype).reshape(shape)*scale</div>
<div class="line">        file.opendata(name+<span class="stringliteral">&#39;_data&#39;</span>)</div>
<div class="line">        get = file.getdata()</div>
<div class="line">        file.closedata()</div>
<div class="line">        <span class="keywordflow">if</span> <span class="keywordflow">not</span> (get == expected).all(): </div>
<div class="line">            fail(<span class="stringliteral">&quot;%s retrieved %s&quot;</span>%(dtype,get))</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    <span class="comment"># Check attribute types</span></div>
<div class="line">    file.opendata(<span class="stringliteral">&#39;r8_data&#39;</span>)</div>
<div class="line">    get = file.getattr(<span class="stringliteral">&quot;ch_attribute&quot;</span>,5,<span class="stringliteral">&#39;char&#39;</span>)</div>
<div class="line">    <span class="keywordflow">if</span> <span class="keywordflow">not</span> get == <span class="stringliteral">&quot;NeXus&quot;</span>: fail(<span class="stringliteral">&quot;ch_attribute retrieved %s&quot;</span>%(get))</div>
<div class="line">    get = file.getattr(<span class="stringliteral">&quot;i4_attribute&quot;</span>,1,<span class="stringliteral">&#39;int32&#39;</span>)</div>
<div class="line">    <span class="keywordflow">if</span> <span class="keywordflow">not</span> get == numpy.int32(42): fail(<span class="stringliteral">&quot;i4_attribute retrieved %s&quot;</span>%(get))</div>
<div class="line">    get = file.getattr(<span class="stringliteral">&quot;r4_attribute&quot;</span>,1,<span class="stringliteral">&#39;float32&#39;</span>)</div>
<div class="line">    <span class="keywordflow">if</span> ((mode==<span class="stringliteral">&#39;wx&#39;</span> <span class="keywordflow">and</span> <span class="keywordflow">not</span> abs(get-3.14159265) &lt; 1e-6) <span class="keywordflow">or</span></div>
<div class="line">        (mode!=<span class="stringliteral">&#39;wx&#39;</span> <span class="keywordflow">and</span> <span class="keywordflow">not</span> get == numpy.float32(3.14159265))):</div>
<div class="line">        fail(<span class="stringliteral">&quot;r4_attribute retrieved %s&quot;</span>%(get))</div>
<div class="line">    <span class="comment">## Oops... NAPI doesn&#39;t support array attributes</span></div>
<div class="line">    <span class="comment">#expect = numpy.array([3,2],dtype=&#39;int32&#39;)</span></div>
<div class="line">    <span class="comment">#get = file.getattr(&quot;i4_array&quot;,2,&#39;int32&#39;)</span></div>
<div class="line">    <span class="comment">#if not (get==expect).all(): fail(&#39;i4_array retrieved %s&#39;%(get))</span></div>
<div class="line">    <span class="comment">#expect = numpy.array([3.14159265,2.718281828],dtype=&#39;float32&#39;)</span></div>
<div class="line">    <span class="comment">#get = file.getattr(&quot;r4_array&quot;,2,dtype=&#39;float32&#39;)</span></div>
<div class="line">    <span class="comment">#if not (get==expect).all(): fail(&quot;r4_array retrieved %s&quot;%(get))</span></div>
<div class="line">    file.closedata()</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    <span class="comment"># Check reading from compressed datasets</span></div>
<div class="line">    comp_array=numpy.ones((100,20),dtype=<span class="stringliteral">&#39;int32&#39;</span>)</div>
<div class="line">    <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(100): comp_array[i,:] *= i</div>
<div class="line">    expected = comp_array</div>
<div class="line">    file.opengroup(<span class="stringliteral">&#39;data&#39;</span>,<span class="stringliteral">&#39;NXdata&#39;</span>) <span class="comment">#/entry/data</span></div>
<div class="line">    file.opendata(<span class="stringliteral">&#39;comp_data&#39;</span>)      <span class="comment">#/entry/data/comp_data</span></div>
<div class="line">    get = file.getdata()</div>
<div class="line">    file.closedata()                <span class="comment">#/entry/data/comp_data</span></div>
<div class="line">    file.closegroup()               <span class="comment">#/entry/data</span></div>
<div class="line">    <span class="keywordflow">if</span> <span class="keywordflow">not</span> (get == expected).all():</div>
<div class="line">        fail(<span class="stringliteral">&quot;compressed data differs&quot;</span>)</div>
<div class="line">        <span class="keywordflow">print</span> get</div>
<div class="line">        </div>
<div class="line">    <span class="comment"># Check strings</span></div>
<div class="line">    file.opengroup(<span class="stringliteral">&#39;sample&#39;</span>,<span class="stringliteral">&#39;NXsample&#39;</span>) <span class="comment">#/entry/sample</span></div>
<div class="line">    file.opendata(<span class="stringliteral">&#39;ch_data&#39;</span>)            <span class="comment">#/entry/sample/ch_data</span></div>
<div class="line">    rawshape,rawdtype = file.getrawinfo()</div>
<div class="line">    shape,dtype = file.getinfo()</div>
<div class="line">    get = file.getdata()</div>
<div class="line">    file.closedata()                    <span class="comment">#/entry/sample/ch_data</span></div>
<div class="line">    file.closegroup()                   <span class="comment">#/entry/sample</span></div>
<div class="line">    <span class="keywordflow">if</span> <span class="keywordflow">not</span> (shape[0]==12 <span class="keywordflow">and</span> dtype==<span class="stringliteral">&#39;char&#39;</span>):</div>
<div class="line">        fail(<span class="stringliteral">&quot;returned string info is incorrect&quot;</span>)</div>
<div class="line">        <span class="keywordflow">print</span> shape,dtype</div>
<div class="line">    <span class="keywordflow">if</span> <span class="keywordflow">not</span> (rawshape[0]==20 <span class="keywordflow">and</span> rawdtype==<span class="stringliteral">&#39;char&#39;</span>):</div>
<div class="line">        fail(<span class="stringliteral">&quot;returned string storage info is incorrect&quot;</span>)</div>
<div class="line">        <span class="keywordflow">print</span> shape,dtype</div>
<div class="line">    <span class="keywordflow">if</span> <span class="keywordflow">not</span> (get == <span class="stringliteral">&quot;NeXus sample&quot;</span>):</div>
<div class="line">        fail(<span class="stringliteral">&quot;returned string is incorrect&quot;</span>)</div>
<div class="line">        <span class="keywordflow">print</span> shape,dtype</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    file.closegroup() <span class="comment">#/entry</span></div>
<div class="line"></div>
<div class="line">    <span class="comment"># Check read slab (e.g., from extensible)</span></div>
<div class="line"></div>
<div class="line">    <span class="comment"># Check links</span></div>
<div class="line">    file.opengroup(<span class="stringliteral">&#39;entry&#39;</span>,<span class="stringliteral">&#39;NXentry&#39;</span>)</div>
<div class="line">    file.opengroup(<span class="stringliteral">&#39;sample&#39;</span>,<span class="stringliteral">&#39;NXsample&#39;</span>)</div>
<div class="line">    sampleid = file.getgroupID()</div>
<div class="line">    file.closegroup() <span class="comment">#/entry/sample</span></div>
<div class="line">    file.opengroup(<span class="stringliteral">&#39;data&#39;</span>,<span class="stringliteral">&#39;NXdata&#39;</span>) <span class="comment">#/entry/data</span></div>
<div class="line">    file.opendata(<span class="stringliteral">&#39;r8_data&#39;</span>) <span class="comment">#/entry/data/r8_data</span></div>
<div class="line">    dataid = file.getdataID()</div>
<div class="line">    file.closedata() <span class="comment">#/entry/data/r8_data</span></div>
<div class="line">    file.closegroup() <span class="comment">#/entry/data</span></div>
<div class="line">    file.opendata(<span class="stringliteral">&#39;r8_data&#39;</span>)</div>
<div class="line">    data2id = file.getdataID()</div>
<div class="line">    file.closedata()</div>
<div class="line">    file.closegroup() <span class="comment">#/entry</span></div>
<div class="line">    <span class="keywordflow">if</span> <span class="keywordflow">not</span> (file.sameID(dataid,data2id)):</div>
<div class="line">        fail(<span class="stringliteral">&quot;/entry/data/r8_data not linked to /entry/r8_data&quot;</span>)</div>
<div class="line">    </div>
<div class="line">    <span class="comment"># Check openpath and getslab</span></div>
<div class="line">    file.openpath(<span class="stringliteral">&#39;/entry/data/comp_data&#39;</span>)</div>
<div class="line">    get = file.getslab([4,4],[5,3])</div>
<div class="line">    expected = comp_array[4:(4+5),4:(4+3)]</div>
<div class="line">    <span class="keywordflow">if</span> <span class="keywordflow">not</span> (get == expected).all():</div>
<div class="line">        fail(<span class="stringliteral">&quot;retrieved compressed slabs differ&quot;</span>)</div>
<div class="line">        <span class="keywordflow">print</span> get</div>
<div class="line">    file.openpath(<span class="stringliteral">&#39;/entry/data/comp_data&#39;</span>)</div>
<div class="line">    get = file.getslab([4,4],[5,3])</div>
<div class="line">    expected = comp_array[4:(4+5),4:(4+3)]</div>
<div class="line">    <span class="keywordflow">if</span> <span class="keywordflow">not</span> (get == expected).all():</div>
<div class="line">        fail(<span class="stringliteral">&quot;after reopen: retrieved compressed slabs differ&quot;</span>)</div>
<div class="line">        <span class="keywordflow">print</span> get</div>
<div class="line">    file.openpath(<span class="stringliteral">&#39;../r8_data&#39;</span>)</div>
<div class="line">    <span class="keywordflow">for</span> k,v <span class="keywordflow">in</span> file.attrs():</div>
<div class="line">        <span class="keywordflow">if</span> k == <span class="stringliteral">&#39;target&#39;</span> <span class="keywordflow">and</span> v != <span class="stringliteral">&#39;/entry/r8_data&#39;</span>:</div>
<div class="line">            fail(<span class="stringliteral">&quot;relative openpath was not successful&quot;</span>)</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> failures == 0</div>
<div class="line"></div>
<div class="line"><span class="keyword">def </span>populate_external(filename,mode):</div>
<div class="line">    ext = dict(w5=<span class="stringliteral">&#39;.h5&#39;</span>,w4=<span class="stringliteral">&#39;.hdf&#39;</span>,wx=<span class="stringliteral">&#39;.xml&#39;</span>)[mode]</div>
<div class="line">    file = nxs.open(filename,mode)</div>
<div class="line">    file.makegroup(<span class="stringliteral">&#39;entry1&#39;</span>,<span class="stringliteral">&#39;NXentry&#39;</span>)</div>
<div class="line">    file.linkexternal(<span class="stringliteral">&#39;entry1&#39;</span>,<span class="stringliteral">&#39;NXentry&#39;</span>,<span class="stringliteral">&#39;nxfile://data/dmc01&#39;</span>+ext)</div>
<div class="line">    file.makegroup(<span class="stringliteral">&#39;entry2&#39;</span>,<span class="stringliteral">&#39;NXentry&#39;</span>)</div>
<div class="line">    file.linkexternal(<span class="stringliteral">&#39;entry2&#39;</span>,<span class="stringliteral">&#39;NXentry&#39;</span>,<span class="stringliteral">&#39;nxfile://data/dmc02&#39;</span>+ext)</div>
<div class="line">    file.makegroup(<span class="stringliteral">&#39;entry3&#39;</span>,<span class="stringliteral">&#39;NXentry&#39;</span>)</div>
<div class="line">    file.close()</div>
<div class="line"></div>
<div class="line"><span class="keyword">def </span>check_external(filename,mode):</div>
<div class="line">    ext = dict(w5=<span class="stringliteral">&#39;.h5&#39;</span>,w4=<span class="stringliteral">&#39;.hdf&#39;</span>,wx=<span class="stringliteral">&#39;.xml&#39;</span>)[mode]</div>
<div class="line">    file = nxs.open(filename,<span class="stringliteral">&#39;rw&#39;</span>)</div>
<div class="line">    </div>
<div class="line">    file.openpath(<span class="stringliteral">&#39;/entry1/start_time&#39;</span>)</div>
<div class="line">    time = file.getdata()</div>
<div class="line">    </div>
<div class="line">    get = file.inquirefile()</div>
<div class="line">    expected = <span class="stringliteral">&#39;nxfile://data/dmc01&#39;</span>+ext</div>
<div class="line">    <span class="keywordflow">if</span> expected != get: fail(<span class="stringliteral">&quot;first external file returned %s&quot;</span>%(get))</div>
<div class="line">    </div>
<div class="line">    file.openpath(<span class="stringliteral">&#39;/entry2/sample/sample_name&#39;</span>)</div>
<div class="line">    sample = file.getdata()</div>
<div class="line"></div>
<div class="line">    get = file.inquirefile()</div>
<div class="line">    expected = <span class="stringliteral">&#39;nxfile://data/dmc02&#39;</span>+ext</div>
<div class="line">    <span class="keywordflow">if</span> expected != get: fail(<span class="stringliteral">&quot;second external file returned %s&quot;</span>%(get))</div>
<div class="line"></div>
<div class="line">    file.openpath(<span class="stringliteral">&#39;/&#39;</span>)</div>
<div class="line">    remote = file.isexternalgroup(<span class="stringliteral">&#39;entry1&#39;</span>,<span class="stringliteral">&#39;NXentry&#39;</span>)</div>
<div class="line">    <span class="keywordflow">if</span> remote <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div>
<div class="line">        fail(<span class="stringliteral">&quot;failed to identify /entry1 as external&quot;</span>)</div>
<div class="line">    remote = file.isexternalgroup(<span class="stringliteral">&#39;entry3&#39;</span>,<span class="stringliteral">&#39;NXentry&#39;</span>)</div>
<div class="line">    <span class="keywordflow">if</span> remote <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>: </div>
<div class="line">        fail(<span class="stringliteral">&#39;incorrectly identified /entry3 as external&#39;</span>)</div>
<div class="line">    </div>
<div class="line">    file.close()</div>
<div class="line"></div>
<div class="line"><span class="keyword">def </span>test_external(mode,quiet=True):</div>
<div class="line">    ext = dict(w5=<span class="stringliteral">&#39;.h5&#39;</span>,w4=<span class="stringliteral">&#39;.hdf&#39;</span>,wx=<span class="stringliteral">&#39;.xml&#39;</span>)[mode]</div>
<div class="line">    filename = <span class="stringliteral">&#39;nxext&#39;</span>+ext</div>
<div class="line">    populate_external(external,mode)</div>
<div class="line">    <span class="keywordflow">if</span> <span class="keywordflow">not</span> quiet:</div>
<div class="line">        show_structure(external)</div>
<div class="line">    failures = check_external(filename,mode)</div>
<div class="line">    <span class="keywordflow">return</span> failures</div>
<div class="line"></div>
<div class="line"><span class="keyword">def </span>test_mode(mode,quiet=True,external=False):</div>
<div class="line">    ext = dict(w5=<span class="stringliteral">&#39;.h5&#39;</span>,w4=<span class="stringliteral">&#39;.hdf&#39;</span>,wx=<span class="stringliteral">&#39;.xml&#39;</span>)[mode]</div>
<div class="line">    filename = <span class="stringliteral">&#39;NXtest&#39;</span>+ext</div>
<div class="line">    populate(filename,mode=mode)</div>
<div class="line">    <span class="keywordflow">if</span> <span class="keywordflow">not</span> quiet <span class="keywordflow">and</span> <span class="stringliteral">&#39;NX_LOAD_PATH&#39;</span> <span class="keywordflow">in</span> os.environ:</div>
<div class="line">        show_structure(<span class="stringliteral">&#39;dmc01&#39;</span>+ext)</div>
<div class="line">    <span class="keywordflow">if</span> <span class="keywordflow">not</span> quiet:</div>
<div class="line">        show_structure(filename)</div>
<div class="line">    failures = check(filename,mode)</div>
<div class="line">    <span class="keywordflow">if</span> external: failures += test_external(mode,quiet)</div>
<div class="line">    <span class="keywordflow">return</span> failures</div>
<div class="line"></div>
<div class="line"><span class="keyword">def </span><a class="code" href="namespacenxs_1_1unit.html#a7efe267a517b6d91818a34a773f49b56">test</a>():</div>
<div class="line">    tests = 0</div>
<div class="line">    <span class="keywordflow">if</span> <span class="stringliteral">&#39;-q&#39;</span> <span class="keywordflow">in</span> sys.argv:</div>
<div class="line">        quiet = <span class="keyword">True</span></div>
<div class="line">    <span class="keywordflow">else</span>:</div>
<div class="line">        quiet = <span class="keyword">False</span></div>
<div class="line">    <span class="keywordflow">if</span> <span class="stringliteral">&#39;-x&#39;</span> <span class="keywordflow">in</span> sys.argv:</div>
<div class="line">        external = <span class="keyword">True</span></div>
<div class="line">        </div>
<div class="line">    <span class="keywordflow">else</span>:</div>
<div class="line">        external = <span class="keyword">False</span></div>
<div class="line">    <span class="keywordflow">if</span> <span class="stringliteral">&#39;hdf4&#39;</span> <span class="keywordflow">in</span> sys.argv: </div>
<div class="line">        test_mode(<span class="stringliteral">&#39;w4&#39;</span>,quiet,external)</div>
<div class="line">        tests += 1</div>
<div class="line">    <span class="keywordflow">if</span> <span class="stringliteral">&#39;xml&#39;</span> <span class="keywordflow">in</span> sys.argv:</div>
<div class="line">        test_mode(<span class="stringliteral">&#39;wx&#39;</span>,quiet,external)</div>
<div class="line">        tests += 1</div>
<div class="line">    <span class="keywordflow">if</span> <span class="stringliteral">&#39;hdf5&#39;</span> <span class="keywordflow">in</span> sys.argv: </div>
<div class="line">        test_mode(<span class="stringliteral">&#39;w5&#39;</span>,quiet,external)</div>
<div class="line">        tests += 1</div>
<div class="line">    <span class="keywordflow">if</span> tests == 0: test_mode(<span class="stringliteral">&#39;w5&#39;</span>,quiet,external)</div>
<div class="line"></div>
<div class="line"><span class="keywordflow">if</span> __name__ == <span class="stringliteral">&quot;__main__&quot;</span>:</div>
<div class="line">    <a class="code" href="namespacenxs_1_1unit.html#a7efe267a517b6d91818a34a773f49b56">test</a>()</div>
<div class="line">    <span class="comment">#leak_test1(n=10000)</span></div>
<div class="line">    </div>
<div class="line"></div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.1.1
</small></address>
</body>
</html>
